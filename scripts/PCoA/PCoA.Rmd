---
title: "PCoA"
author: "Nicole Anthony"
date: "`r Sys.Date()`"
output:
  word_document: default
  html_document: default
  pdf_document: default
---

# Introduction
This analysis uses publicly available data from Ballini, L., Staffoni, G., Nespoli, D. et al. *Environmental DNA metabarcoding as an efficient tool to monitor freshwater systems in northwestern Italy.* Hydrobiologia (2024). eDNA metabarcoding sample sequences were initially processed using Barque v1.8.5 (https://github.com/enormandeau/barque), an eDNA metabarcoding analysis pipeline that denoises and then annotates Amplicon Sequence Variants (ASVs) or Operational Taxonomic Units (OTUs) using high-quality reference databases.

# Ordination Analysis Using Principal Coordinates Analysis (PCoA)
Following data curation with LULU and contamination removal with microDecon, we applied Principal Coordinates Analysis (PCoA) to explore patterns of beta diversity (community composition differences) across river sites and primer markers. PCoA is a multivariate ordination technique that reduces dimensionality in complex ecological datasets, allowing for visualization of community composition differences.

Bray-Curtis dissimilarity was used to construct a distance matrix based on presence-absence data, as read counts in eDNA metabarcoding do not reliably represent species abundance. This approach enables us to examine how species composition varies between rivers, assess the consistency of replicates, and evaluate differences in taxonomic resolution between primer markers.

PERMANOVA (Permutational Multivariate Analysis of Variance) was used to test whether beta diversityis significantly affected by river site and primer marker.

The results of this analysis provide insight into the ecological distinctiveness of river communities and the methodological impact of different primer choices in eDNA metabarcoding studies.


```{r}
# load libraries
library(vegan)    # for Bray-Curtis dissimilarity, PCoA and PERMANOVA
library(ape)      # for PCoA function
library(ggplot2)  # for plotting
library(dplyr)    # for data wrangling
library(tidyr)    # for reshaping data
library(readr)    # for reading CSV files
library(devtools)
# install_github("pmartinezarbizu/pairwiseAdonis/pairwiseAdonis")
library(pairwiseAdonis) # for pairwise PERMANOVA (Post-Hoc)
```

## PCoA
### Step 1: Load and Merge All OTU Tables
```{r}
# set working directory
setwd("/Users/Angel/Desktop/eDNA_projects/Italy/analyses/PCoA")

# list all relevant csv files
otu_files <- list.files(pattern = "*_cleaned.csv")  # ignore microdecon input files

# function to read and process each OTU table
load_otu_data <- function(file) {
  df <- read_csv(file)
  
  # extract river and marker from filename (assuming "marker_river_cleaned.csv" format)
  file_parts <- strsplit(file, "_")[[1]]
  marker <- file_parts[1]  # tele02 or vert01
  river <- file_parts[2]   # argentina, bevera, etc.
  
  # reshape from wide to long format: OTU_ID, SampleID, Read_Count
  df_long <- pivot_longer(df, cols = -OTU_ID, names_to = "SampleID", values_to = "Read_Count")
  
  # add metadata columns
  df_long$River <- river
  df_long$Marker <- marker
  
  return(df_long)
}

# load and merge all OTU tables
otu_data <- bind_rows(lapply(otu_files, load_otu_data))
```

### Step 2: Convert Read Counts to Presence/Absence
```{r}
otu_data <- otu_data %>%
  mutate(Presence = ifelse(Read_Count > 0, 1, 0)) %>%  # convert to binary
  select(-Read_Count)  # remove raw read counts

# reshape back to wide format: Samples as rows, OTUs as columns
otu_wide <- otu_data %>%
  pivot_wider(names_from = "OTU_ID", values_from = "Presence", values_fill = 0)

# extract metadata
metadata <- otu_wide %>% select(SampleID, River, Marker)

# remove non-numeric columns to create the OTU presence-absence matrix
otu_matrix <- otu_wide %>% select(-SampleID, -River, -Marker)

# identify Samples with No OTUs
# count the number of OTUs per sample
otu_nonzero_counts <- rowSums(otu_matrix)

# identify samples with zero OTUs
empty_samples <- metadata$SampleID[otu_nonzero_counts == 0]

# print empty samples
print(empty_samples)

# filter out samples with no detected OTUs
otu_matrix_filtered <- otu_matrix[rowSums(otu_matrix) > 0, ]
metadata_filtered <- metadata[rowSums(otu_matrix) > 0, ]
```


### Step 3: Compute Bray-Curtis Dissimilarity
```{r}
dist_matrix <- vegdist(otu_matrix_filtered, method = "bray")

# check if missing values persist
any(is.na(dist_matrix))
```

### Step 4: Perform PCoA
```{r}
pcoa_result <- pcoa(dist_matrix)

# extract first two principal coordinates
pcoa_scores <- as.data.frame(pcoa_result$vectors[, 1:2])
colnames(pcoa_scores) <- c("PCoA1", "PCoA2")
pcoa_scores$SampleID <- metadata_filtered$SampleID
```


### Step 5: Merge with Metadata and Plot 
```{r}
pcoa_plot_data <- left_join(pcoa_scores, metadata, by = "SampleID")

ggplot(pcoa_plot_data, aes(x = PCoA1, y = PCoA2, color = River, shape = Marker)) +
  geom_point(size = 4, alpha = 0.8) +
  stat_ellipse(aes(group = interaction(River, Marker)), linetype = "dashed") +  # fixes warning
  theme_minimal() +
  labs(title = "PCoA of eDNA Samples by River and Primer Marker
       (Bray-Curtis, Presence/Absence)",
       x = paste0("PCoA1 (", round(pcoa_result$values$Relative_eig[1] * 100, 2), "%)"),
       y = paste0("PCoA2 (", round(pcoa_result$values$Relative_eig[2] * 100, 2), "%)"),
       color = "River",
       shape = "Marker")
```
Figure caption
This PCoA (Principal Coordinates Analysis) plot visualizes beta diversity (variation in community composition) among eDNA samples from six rivers (color-coded) using two primer markers (shapes: circles for tele02, triangles for vert01).

Key Observations & Interpretation
1. River Clustering Patterns
Distinct clustering per river → Indicates species composition differences among river sites.
Example: The Argentina (red) and Tanaro (pink) river samples are well-separated from others.
Roia (blue) and Bevera (yellow) show tight clustering, suggesting more similar communities within those sites.
Carpasina (green) and Nervia (cyan) are more spread out, possibly indicating more diverse communities within those rivers.

2. Variation Between Primer Markers (tele02 vs. vert01)
Some rivers (e.g., Tanaro, Argentina) have clear separation between primer markers:
This suggests that tele02 and vert01 may amplify different taxa, detecting different subsets of the community.
In other rivers (e.g., Roia, Bevera), both markers cluster more closely together:
This suggests that both markers are capturing similar community structures in these sites.

3. Spread of Replicates
Tight clusters (e.g., Roia, Bevera) → High reproducibility among replicates (low variability).
Wide dispersion (e.g., Nervia, Carpasina, Argentina) → Suggests greater within-site variability, possibly due to:
Higher habitat heterogeneity within the river.
Variability in detection due to environmental conditions (e.g., water flow, degradation rates).
PCR or sequencing variation affecting detection.

4. PCoA Axis Interpretation
PCoA1 (27.73% of variation explained) → Likely represents the main gradient in community differences between river sites.
PCoA2 (11.19% of variation explained) → Captures a secondary gradient, possibly driven by primer marker differences or finer-scale site variation.

## PERMANOVA

### Interaction
This tests:
Main effect of River → Do different rivers have different eDNA communities?
Main effect of Marker → Do different primer markers detect different communities?
Interaction: River × Marker → Does the effect of River differ depending on the marker?

```{r}
# run PERMANOVA using Bray-Curtis distance matrix
permanova_result <- adonis2(dist_matrix ~ River * Marker, data = metadata_filtered, permutations = 999, method = "bray")

# print results
print(permanova_result)
```
Key Findings

Strong Overall Effect (p = 0.001)
The model is highly significant (p = 0.001*), meaning that River and/or Marker significantly influence species composition.
F = 10.401 → A high F-value suggests a strong effect of these variables.
R² = 0.634 (63.4%) → 63.4% of the variance in species composition is explained by River and Marker, while 36.6% remains unexplained.

This means that rivers differ significantly in their species composition. Primer markers also contribute to differences, but the test does not yet specify whether the effect is mainly due to river, marker, or an interaction of both.

```{r}
# pairwise comparisons for River
pairwise_result <- pairwise.adonis2(dist_matrix ~ River, data = metadata_filtered, permutations = 999)

# print results
print(pairwise_result)
```

Pairwise PERMANOVA results compare each river pairwise to test if their eDNA community compositions are significantly different.

Key Findings

Most river pairs are significantly different (p < 0.05)
Almost all river pairs show significant differences (p < 0.05), suggesting distinct community compositions.
Example:
Argentina vs. Bevera (p = 0.001)
Argentina vs. Carpasina (p = 0.001)
Argentina vs. Roia (p = 0.001)
Bevera vs. Tanaro (p = 0.001)
Roia vs. Tanaro (p = 0.001)
These very low p-values indicate strong differences between these rivers.

Some river pairs show weaker or no significant differences
Carpasina vs. Nervia (p = 0.053) → Not significant at p < 0.05, meaning these two rivers may have more similar community compositions.
Bevera vs. Roia (p = 0.219) → Not significant, suggesting Roia and Bevera have similar eDNA-based communities. These rivers are geographically close and may feed from the same main stem upstream.

Effect Sizes (R² Values)
Higher R² = Greater difference in community composition.
Argentina vs. Bevera (R² = 0.206)
Argentina vs. Carpasina (R² = 0.174)
Roia vs. Tanaro (R² = 0.157)
These suggest large differences in community composition.

Lower R² = More similar communities.
Carpasina vs. Nervia (R² = 0.078) → Very similar.
Bevera vs. Roia (R² = 0.042) → Very small difference.


Biological Interpretation
Most rivers have significantly different community compositions. This suggests strong local environmental influences or hydrological separation affecting species presence. Some rivers (e.g., Bevera vs. Roia) have similar eDNA compositions.

These sites may be ecologically connected or share similar environmental conditions.
Primer choice (tele02 vs. vert01) may contribute to variability.

We may want to stratify results by marker to see if one primer detects stronger differences than the other.

### Stratify by Marker
Does community composition differ between rivers when using only tele02? How about with only vert01?
Which marker captures stronger river differences. If one shows high R² and significance and the other doesn’t, it suggests it's more effective or consistent.
```{r}
# for tele02 only
tele_data <- metadata_filtered %>% filter(Marker == "tele02")
tele_dist <- vegdist(otu_matrix_filtered[metadata_filtered$Marker == "tele02", ], method = "bray")
adonis2(tele_dist ~ River, data = tele_data, permutations = 999)

# for vert01 only
vert_data <- metadata_filtered %>% filter(Marker == "vert01")
vert_dist <- vegdist(otu_matrix_filtered[metadata_filtered$Marker == "vert01", ], method = "bray")
adonis2(vert_dist ~ River, data = vert_data, permutations = 999)
```
Key Findings

When analyzing river-specific patterns separately by primer marker, we found that tele02 explains a larger proportion of community variation (R² = 0.594, p = 0.001) than vert01 (R² = 0.421, p = 0.001). This indicates that tele02 provides more distinct and consistent river-level community profiles, and may therefore be a more robust marker for detecting spatial patterns in freshwater eDNA metabarcoding.

```{r}
ggplot(pcoa_plot_data, aes(x = PCoA1, y = PCoA2, color = River)) +
  geom_point(size = 4, alpha = 0.8) +
  stat_ellipse(aes(group = River), linetype = "dashed") +
  facet_wrap(~ Marker) +
  theme_minimal() +
  labs(title = "PCoA of eDNA Samples by River, Faceted by Primer Marker",
       x = paste0("PCoA1 (", round(pcoa_result$values$Relative_eig[1] * 100, 2), "%)"),
       y = paste0("PCoA2 (", round(pcoa_result$values$Relative_eig[2] * 100, 2), "%)"),
       color = "River")

```

```{r}
# calculate Bray-Curtis distance matrix
dist_matrix <- vegdist(otu_matrix_filtered, method = "bray")

# run PERMDISP: test if dispersion differs between tele02 and vert01
group_dispersion <- betadisper(dist_matrix, metadata_filtered$Marker)

# test for significance
permdisp_result <- permutest(group_dispersion, permutations = 999)
print(permdisp_result)

# optionally plot
plot(group_dispersion)

print(permdisp_result)
```

Key Findings

Our comparison of primer markers reveals that tele02 outperforms vert01 in terms of both between-group separation and within-group consistency. 

A PERMDISP test revealed a significant difference in within-group beta diversity between primer markers (F = 5.08, p = 0.023), with tele02 exhibiting lower dispersion than vert01. This finding supports visual observations from the PCoA plot and indicates that tele02 provides more consistent detection of riverine eDNA communities across replicates.

PCoA ordination and PERMDISP tests demonstrate that tele02 provides tighter, more distinct clustering by river, while vert01 shows higher dispersion and overlapping community profiles. These results suggest that tele02 is the more robust marker for detecting ecologically meaningful differences in freshwater eDNA community composition.

